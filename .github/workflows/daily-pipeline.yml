name: Daily Pipeline

on:
  schedule:
    # TESTING: Runs every day at 12:35 PM PST (20:35 UTC)
    # PST is UTC-8, so 12:35 PM PST = 8:35 PM UTC (20:35)
    # TODO: Change back to 10:00 AM PST (18:00 UTC) after testing
    - cron: '35 20 * * *'
  workflow_dispatch: # Allows manual triggering

jobs:
  daily-job:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install uv
        run: pip install uv
      
      - name: Install dependencies
        run: uv sync
      
      - name: Verify secrets are set
        run: |
          echo "Checking required secrets..."
          if [ -z "${{ secrets.LINKEDIN_ACCESS_TOKEN }}" ]; then
            echo "ERROR: LINKEDIN_ACCESS_TOKEN secret is not set!"
            exit 1
          fi
          if [ -z "${{ secrets.PERSON_URN }}" ]; then
            echo "ERROR: LINKEDIN_PERSON_URN secret is not set!"
            exit 1
          fi
          echo "âœ“ All required secrets are set"
      
      - name: Run daily workflow
        env:
          GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
          GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
          Groq_Api_Key: ${{ secrets.GROQ_API_KEY }}
          Gemini_Api_Key: ${{ secrets.GEMINI_API_KEY }}
          CLIENT_ID: ${{ secrets.LINKEDIN_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.LINKEDIN_CLIENT_SECRET }}
          access_token: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          PERSON_URN: ${{ secrets.LINKEDIN_PERSON_URN }}
        run: |
          echo "Starting daily workflow at $(date)"
          echo "Timezone: $(date +%Z)"
          echo "Verifying environment variables..."
          echo "access_token is set: $([ -n "$access_token" ] && echo 'Yes' || echo 'No')"
          echo "PERSON_URN is set: $([ -n "$PERSON_URN" ] && echo 'Yes' || echo 'No')"
          uv run daily_workflow.py
          echo "Workflow completed at $(date)"
